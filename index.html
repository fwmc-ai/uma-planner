<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Uma Musume Pretty Derby Global Career Planner - Complete character database and training optimizer">
    <meta name="theme-color" content="#ec4899">
    
    <title>Uma Musume Career Planner</title>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏇</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏇</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Just using vanilla JavaScript - no React needed -->
    <script>
        // Simple icon replacement system
        const Icons = {
            Search: '🔍',
            Filter: '🔧',
            ArrowLeft: '←',
            Target: '🎯',
            TrendingUp: '📈',
            Users: '👥',
            Star: '⭐',
            RotateCcw: '🔄',
            ChevronDown: '▼',
            ChevronUp: '▲',
            Info: 'ℹ️',
            Book: '📖',
            Trophy: '🏆',
            Sparkles: '✨',
            Heart: '❤️'
        };
    </script>
    
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(to bottom right, #fef3c7, #dbeafe, #f3e8ff);">
            <div style="text-align: center;">
                <div class="loading"></div>
                <p style="margin-top: 20px; color: #374151;">Loading Uma Musume Career Planner...</p>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let appState = {
            currentView: 'home',
            selectedCharacter: null,
            searchTerm: '',
            targetTrack: 'mile',
            style: 'pace-chaser',
            costumeMode: 'school', // 'school' or 'secondary'
            stats: {
                speed: 300,
                stamina: 300,
                power: 300,
                guts: 300,
                wisdom: 300
            }
        };

        // Constants defined first
        const STYLES = ['front-runner', 'pace-chaser', 'late-surger', 'end-closer'];
        const TRACK_TYPES = ['sprint', 'mile', 'medium', 'long'];
        const RARITIES = [1, 2, 3];
        const APTITUDE_GRADES = ['S', 'A', 'B', 'C', 'D', 'E', 'F', 'G'];

        // Complete character database with accurate data from Uma Musume Global
        const CHARACTERS = [
          // 🆕 NEWEST CHARACTERS (July 2025)
          {
            id: 'biwa_hayahide',
            name: 'Biwa Hayahide',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            aptitudes: { turf: 'A', dirt: 'F', sprint: 'F', mile: 'C', medium: 'A', long: 'A' },
            runningStyles: { front: 'E', pace: 'A', late: 'B', end: 'E' },
            statGrowth: { speed: 0, stamina: 0, power: 0, guts: 10, wisdom: 20 },
            baseStats: { speed: 85, stamina: 93, power: 82, guts: 93, wisdom: 97 },
            fanGoalThresholds: [8000],
            image: '🏇',
            uniqueSkill: '∴win Q.E.D.'
          },
          {
            id: 'mihono_bourbon',
            name: 'Mihono Bourbon',
            rarity: 3,
            defaultStyle: 'front-runner',
            styles: ['front-runner', 'pace-chaser'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'C', mile: 'B', medium: 'A', long: 'B' },
            runningStyles: { front: 'A', pace: 'B', late: 'E', end: 'G' },
            statGrowth: { speed: 0, stamina: 20, power: 10, guts: 0, wisdom: 0 },
            baseStats: { speed: 82, stamina: 92, power: 88, guts: 85, wisdom: 89 },
            fanGoalThresholds: [5000],
            image: '🤖',
            uniqueSkill: 'G00 1st. F∞'
          },

          // 3★ Rarity Characters (June 26th Global Launch)
          {
            id: 'special_week',
            name: 'Special Week',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'F', mile: 'C', medium: 'A', long: 'A' },
            runningStyles: { front: 'G', pace: 'A', late: 'A', end: 'C' },
            statGrowth: { speed: 0, stamina: 20, power: 0, guts: 0, wisdom: 10 },
            baseStats: { speed: 83, stamina: 88, power: 98, guts: 90, wisdom: 91 },
            fanGoalThresholds: [5000],
            image: '🌟',
            uniqueSkill: 'Shooting Star'
          },
          {
            id: 'silence_suzuka',
            name: 'Silence Suzuka',
            rarity: 3,
            defaultStyle: 'front-runner',
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'D', mile: 'A', medium: 'A', long: 'E' },
            runningStyles: { front: 'A', pace: 'C', late: 'E', end: 'G' },
            statGrowth: { speed: 20, stamina: 0, power: 0, guts: 10, wisdom: 0 },
            baseStats: { speed: 101, stamina: 84, power: 77, guts: 100, wisdom: 88 },
            fanGoalThresholds: [5000],
            image: '🌸',
            uniqueSkill: "I'm Not Giving Up the Lead...!"
          },
          {
            id: 'tokai_teio',
            name: 'Tokai Teio',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'F', mile: 'E', medium: 'A', long: 'B' },
            runningStyles: { front: 'C', pace: 'A', late: 'B', end: 'E' },
            statGrowth: { speed: 20, stamina: 10, power: 0, guts: 0, wisdom: 0 },
            baseStats: { speed: 90, stamina: 89, power: 83, guts: 92, wisdom: 96 },
            fanGoalThresholds: [5000],
            image: '👑',
            uniqueSkill: 'Sky-High Teio Step'
          },
          {
            id: 'maruzensky',
            name: 'Maruzensky',
            rarity: 3,
            defaultStyle: 'front-runner',
            styles: ['front-runner', 'pace-chaser'],
            aptitudes: { turf: 'A', dirt: 'D', sprint: 'B', mile: 'A', medium: 'B', long: 'C' },
            runningStyles: { front: 'A', pace: 'B', late: 'D', end: 'E' },
            statGrowth: { speed: 10, stamina: 0, power: 0, guts: 0, wisdom: 20 },
            baseStats: { speed: 88, stamina: 84, power: 86, guts: 95, wisdom: 92 },
            fanGoalThresholds: [3000],
            image: '🌺',
            uniqueSkill: 'Red Shift/LP1211-M'
          },
          {
            id: 'oguri_cap',
            name: 'Oguri Cap',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'B', sprint: 'E', mile: 'A', medium: 'A', long: 'B' },
            runningStyles: { front: 'C', pace: 'A', late: 'A', end: 'B' },
            statGrowth: { speed: 20, stamina: 0, power: 10, guts: 0, wisdom: 0 },
            baseStats: { speed: 101, stamina: 66, power: 106, guts: 84, wisdom: 93 },
            fanGoalThresholds: [10000],
            image: '🏆',
            uniqueSkill: 'Triumphant Pulse'
          },
          {
            id: 'rice_shower',
            name: 'Rice Shower',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'E', mile: 'C', medium: 'A', long: 'A' },
            runningStyles: { front: 'E', pace: 'A', late: 'B', end: 'C' },
            statGrowth: { speed: 0, stamina: 10, power: 0, guts: 20, wisdom: 0 },
            baseStats: { speed: 71, stamina: 117, power: 70, guts: 102, wisdom: 90 },
            fanGoalThresholds: [5000, 15000],
            image: '🌧️',
            uniqueSkill: 'Blue Rose Closer'
          },
          {
            id: 'taiki_shuttle',
            name: 'Taiki Shuttle',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            styles: ['front-runner', 'pace-chaser'],
            aptitudes: { turf: 'A', dirt: 'B', sprint: 'A', mile: 'A', medium: 'E', long: 'G' },
            runningStyles: { front: 'B', pace: 'A', late: 'C', end: 'E' },
            statGrowth: { speed: 20, stamina: 0, power: 0, guts: 0, wisdom: 10 },
            baseStats: { speed: 96, stamina: 71, power: 98, guts: 93, wisdom: 92 },
            fanGoalThresholds: [10000],
            image: '✈️',
            uniqueSkill: 'Shooting for Victory!'
          },
          {
            id: 'mejiro_mcqueen',
            name: 'Mejiro McQueen',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            aptitudes: { turf: 'A', dirt: 'E', sprint: 'G', mile: 'F', medium: 'A', long: 'A' },
            runningStyles: { front: 'B', pace: 'A', late: 'C', end: 'E' },
            statGrowth: { speed: 0, stamina: 20, power: 0, guts: 0, wisdom: 10 },
            baseStats: { speed: 78, stamina: 108, power: 85, guts: 88, wisdom: 91 },
            fanGoalThresholds: [15000],
            image: '👸',
            uniqueSkill: 'The Duty of Dignity Calls'
          },
          {
            id: 'symboli_rudolf',
            name: 'Symboli Rudolf',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'E', mile: 'C', medium: 'A', long: 'A' },
            runningStyles: { front: 'C', pace: 'A', late: 'A', end: 'B' },
            statGrowth: { speed: 0, stamina: 20, power: 0, guts: 10, wisdom: 0 },
            baseStats: { speed: 86, stamina: 91, power: 83, guts: 96, wisdom: 94 },
            fanGoalThresholds: [20000],
            image: '⚜️',
            uniqueSkill: "Behold Thine Emperor's Divine Might"
          },
          {
            id: 'marvelous_sunday',
            name: 'Marvelous Sunday',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'F', sprint: 'G', mile: 'C', medium: 'A', long: 'B' },
            runningStyles: { front: 'D', pace: 'A', late: 'A', end: 'C' },
            statGrowth: { speed: 0, stamina: 0, power: 15, guts: 0, wisdom: 15 },
            baseStats: { speed: 84, stamina: 87, power: 89, guts: 85, wisdom: 90 },
            fanGoalThresholds: [10000, 15000],
            image: '☀️',
            uniqueSkill: 'GALmem. forever♪'
          },
          {
            id: 'yukino_bijin',
            name: 'Yukino Bijin',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            styles: ['front-runner', 'pace-chaser'],
            aptitudes: { turf: 'A', dirt: 'B', sprint: 'D', mile: 'A', medium: 'A', long: 'E' },
            runningStyles: { front: 'D', pace: 'A', late: 'B', end: 'C' },
            statGrowth: { speed: 10, stamina: 0, power: 0, guts: 20, wisdom: 0 },
            baseStats: { speed: 89, stamina: 79, power: 87, guts: 91, wisdom: 84 },
            fanGoalThresholds: [3000, 10000],
            image: '❄️',
            uniqueSkill: "I'm Possible"
          },
          {
            id: 'eishin_flash',
            name: 'Eishin Flash',
            rarity: 3,
            defaultStyle: 'late-surger',
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'G', mile: 'F', medium: 'A', long: 'A' },
            runningStyles: { front: 'E', pace: 'C', late: 'A', end: 'B' },
            statGrowth: { speed: 0, stamina: 0, power: 10, guts: 0, wisdom: 20 },
            baseStats: { speed: 100, stamina: 83, power: 93, guts: 82, wisdom: 92 },
            fanGoalThresholds: [10000],
            image: '⚡',
            uniqueSkill: 'Schwarzes Schwert'
          },
          {
            id: 'tm_opera_o',
            name: 'T.M. Opera O',
            rarity: 3,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'G', mile: 'F', medium: 'A', long: 'A' },
            runningStyles: { front: 'E', pace: 'A', late: 'B', end: 'C' },
            statGrowth: { speed: 0, stamina: 20, power: 0, guts: 0, wisdom: 10 },
            baseStats: { speed: 75, stamina: 108, power: 75, guts: 102, wisdom: 90 },
            fanGoalThresholds: [15000],
            image: '🎭',
            uniqueSkill: 'Operatic Finale'
          },

          // 2★ Rarity Characters (June 26th Global Launch)
          {
            id: 'gold_ship',
            name: 'Gold Ship',
            rarity: 2,
            defaultStyle: 'end-closer',
            styles: ['late-surger', 'end-closer'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'G', mile: 'C', medium: 'A', long: 'A' },
            runningStyles: { front: 'G', pace: 'E', late: 'B', end: 'A' },
            statGrowth: { speed: 0, stamina: 20, power: 10, guts: 0, wisdom: 0 },
            baseStats: { speed: 82, stamina: 96, power: 100, guts: 77, wisdom: 70 },
            fanGoalThresholds: [3000, 6000, 10000],
            image: '🚢',
            uniqueSkill: 'Warning Shot!'
          },
          {
            id: 'vodka',
            name: 'Vodka',
            rarity: 2,
            defaultStyle: 'late-surger',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'F', mile: 'A', medium: 'A', long: 'F' },
            runningStyles: { front: 'E', pace: 'C', late: 'A', end: 'B' },
            statGrowth: { speed: 10, stamina: 0, power: 20, guts: 0, wisdom: 0 },
            baseStats: { speed: 96, stamina: 61, power: 105, guts: 75, wisdom: 88 },
            fanGoalThresholds: [2000, 5000, 8000],
            image: '🍸',
            uniqueSkill: 'Xceleration'
          },
          {
            id: 'daiwa_scarlet',
            name: 'Daiwa Scarlet',
            rarity: 2,
            defaultStyle: 'front-runner',
            styles: ['front-runner', 'pace-chaser'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'F', mile: 'A', medium: 'A', long: 'B' },
            runningStyles: { front: 'A', pace: 'A', late: 'D', end: 'E' },
            statGrowth: { speed: 10, stamina: 0, power: 0, guts: 20, wisdom: 0 },
            baseStats: { speed: 84, stamina: 77, power: 79, guts: 95, wisdom: 90 },
            fanGoalThresholds: [3000, 8000, 10000],
            image: '🌹',
            uniqueSkill: 'Red Ace'
          },
          {
            id: 'mayano_top_gun',
            name: 'Mayano Top Gun',
            rarity: 2,
            defaultStyle: 'pace-chaser',
            styles: ['front-runner', 'pace-chaser'],
            aptitudes: { turf: 'A', dirt: 'E', sprint: 'E', mile: 'C', medium: 'A', long: 'A' },
            runningStyles: { front: 'C', pace: 'A', late: 'B', end: 'D' },
            statGrowth: { speed: 0, stamina: 20, power: 0, guts: 10, wisdom: 0 },
            baseStats: { speed: 73, stamina: 100, power: 67, guts: 95, wisdom: 90 },
            fanGoalThresholds: [10000],
            image: '✈️',
            uniqueSkill: '1st Place Kiss☆'
          },
          {
            id: 'super_creek',
            name: 'Super Creek',
            rarity: 2,
            defaultStyle: 'pace-chaser',
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'G', mile: 'G', medium: 'A', long: 'A' },
            runningStyles: { front: 'C', pace: 'A', late: 'B', end: 'E' },
            statGrowth: { speed: 0, stamina: 10, power: 0, guts: 0, wisdom: 20 },
            baseStats: { speed: 76, stamina: 106, power: 75, guts: 98, wisdom: 97 },
            fanGoalThresholds: [5000, 9000],
            image: '🏞️',
            uniqueSkill: 'Clear Heart'
          },
          {
            id: 'grass_wonder',
            name: 'Grass Wonder',
            rarity: 2,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'G', mile: 'A', medium: 'B', long: 'A' },
            runningStyles: { front: 'D', pace: 'A', late: 'A', end: 'C' },
            statGrowth: { speed: 20, stamina: 0, power: 10, guts: 0, wisdom: 0 },
            baseStats: { speed: 91, stamina: 83, power: 97, guts: 79, wisdom: 100 },
            fanGoalThresholds: [1500, 4000, 8000],
            image: '🌱',
            uniqueSkill: 'Focused Mind'
          },
          {
            id: 'el_condor_pasa',
            name: 'El Condor Pasa',
            rarity: 2,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'B', sprint: 'F', mile: 'A', medium: 'A', long: 'B' },
            runningStyles: { front: 'B', pace: 'A', late: 'B', end: 'D' },
            statGrowth: { speed: 20, stamina: 0, power: 0, guts: 0, wisdom: 10 },
            baseStats: { speed: 100, stamina: 75, power: 91, guts: 97, wisdom: 87 },
            fanGoalThresholds: [3000, 10000],
            image: '🦅',
            uniqueSkill: 'Corazón ☆ Ardiente'
          },
          {
            id: 'air_groove',
            name: 'Air Groove',
            rarity: 2,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'E', sprint: 'E', mile: 'B', medium: 'A', long: 'A' },
            runningStyles: { front: 'C', pace: 'A', late: 'B', end: 'D' },
            statGrowth: { speed: 10, stamina: 0, power: 10, guts: 10, wisdom: 0 },
            baseStats: { speed: 94, stamina: 82, power: 91, guts: 88, wisdom: 95 },
            fanGoalThresholds: [8000, 10000],
            image: '💨',
            uniqueSkill: "Empress's Pride"
          },

          // 1★ Rarity Characters (June 26th Global Launch)
          {
            id: 'mejiro_ryan',
            name: 'Mejiro Ryan',
            rarity: 1,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'D', sprint: 'D', mile: 'C', medium: 'A', long: 'A' },
            runningStyles: { front: 'D', pace: 'A', late: 'B', end: 'C' },
            statGrowth: { speed: 0, stamina: 0, power: 20, guts: 0, wisdom: 10 },
            baseStats: { speed: 82, stamina: 85, power: 89, guts: 78, wisdom: 86 },
            fanGoalThresholds: [5000, 9000],
            image: '🦁',
            uniqueSkill: 'Feel the Burn!'
          },
          {
            id: 'agnes_tachyon',
            name: 'Agnes Tachyon',
            rarity: 1,
            defaultStyle: 'pace-chaser',
            styles: ['pace-chaser', 'late-surger'],
            aptitudes: { turf: 'A', dirt: 'D', sprint: 'E', mile: 'B', medium: 'A', long: 'B' },
            runningStyles: { front: 'D', pace: 'A', late: 'B', end: 'C' },
            statGrowth: { speed: 20, stamina: 0, power: 0, guts: 10, wisdom: 0 },
            baseStats: { speed: 82, stamina: 76, power: 76, guts: 79, wisdom: 87 },
            fanGoalThresholds: [4000, 8000],
            image: '🔬',
            uniqueSkill: 'Introduction to Physiology'
          },
          {
            id: 'winning_ticket',
            name: 'Winning Ticket',
            rarity: 1,
            defaultStyle: 'late-surger',
            styles: ['late-surger', 'end-closer'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'G', mile: 'F', medium: 'A', long: 'B' },
            runningStyles: { front: 'G', pace: 'D', late: 'A', end: 'B' },
            statGrowth: { speed: 0, stamina: 10, power: 20, guts: 0, wisdom: 0 },
            baseStats: { speed: 87, stamina: 68, power: 91, guts: 74, wisdom: 80 },
            fanGoalThresholds: [3000, 8000],
            image: '🎫',
            uniqueSkill: 'V Is for Victory!'
          },
          {
            id: 'sakura_bakushin_o',
            name: 'Sakura Bakushin O',
            rarity: 1,
            defaultStyle: 'front-runner',
            styles: ['front-runner', 'pace-chaser'],
            aptitudes: { turf: 'A', dirt: 'G', sprint: 'A', mile: 'E', medium: 'G', long: 'G' },
            runningStyles: { front: 'A', pace: 'C', late: 'G', end: 'G' },
            statGrowth: { speed: 20, stamina: 0, power: 0, guts: 10, wisdom: 0 },
            baseStats: { speed: 87, stamina: 54, power: 93, guts: 85, wisdom: 81 },
            fanGoalThresholds: [1000, 3000, 5000],
            image: '🌸',
            uniqueSkill: 'Class Rep + Speed = Bakushin'
          },
          {
            id: 'haru_urara',
            name: 'Haru Urara',
            rarity: 1,
            defaultStyle: 'late-surger',
            aptitudes: { turf: 'E', dirt: 'A', sprint: 'B', mile: 'C', medium: 'F', long: 'G' },
            runningStyles: { front: 'G', pace: 'E', late: 'B', end: 'A' },
            statGrowth: { speed: 0, stamina: 0, power: 10, guts: 20, wisdom: 0 },
            baseStats: { speed: 83, stamina: 58, power: 89, guts: 86, wisdom: 84 },
            fanGoalThresholds: [5000, 9000],
            image: '🌻',
            uniqueSkill: 'Super-Duper Stoked'
          },
          {
            id: 'matikanefukukitaru',
            name: 'Matikanefukukitaru',
            rarity: 1,
            defaultStyle: 'late-surger',
            aptitudes: { turf: 'A', dirt: 'E', sprint: 'C', mile: 'B', medium: 'A', long: 'A' },
            runningStyles: { front: 'D', pace: 'A', late: 'B', end: 'C' },
            statGrowth: { speed: 0, stamina: 20, power: 10, guts: 0, wisdom: 0 },
            baseStats: { speed: 77, stamina: 81, power: 88, guts: 81, wisdom: 73 },
            fanGoalThresholds: [4000, 8000],
            image: '🍀',
            uniqueSkill: 'Luck Be with Me!'
          },
          {
            id: 'nice_nature',
            name: 'Nice Nature',
            rarity: 1,
            defaultStyle: 'late-surger',
            styles: ['late-surger', 'end-closer'],
            aptitudes: { turf: 'A', dirt: 'D', sprint: 'D', mile: 'B', medium: 'A', long: 'B' },
            runningStyles: { front: 'G', pace: 'C', late: 'A', end: 'B' },
            statGrowth: { speed: 0, stamina: 0, power: 20, guts: 0, wisdom: 10 },
            baseStats: { speed: 86, stamina: 72, power: 89, guts: 69, wisdom: 84 },
            fanGoalThresholds: [3000, 7000],
            image: '🥉',
            uniqueSkill: 'I Can Win Sometimes, Right?'
          },
          {
            id: 'king_halo',
            name: 'King Halo',
            rarity: 1,
            defaultStyle: 'late-surger',
            aptitudes: { turf: 'A', dirt: 'F', sprint: 'B', mile: 'A', medium: 'B', long: 'D' },
            runningStyles: { front: 'C', pace: 'A', late: 'B', end: 'D' },
            statGrowth: { speed: 0, stamina: 0, power: 20, guts: 10, wisdom: 0 },
            baseStats: { speed: 87, stamina: 60, power: 93, guts: 73, wisdom: 87 },
            fanGoalThresholds: [3000, 6000],
            image: '👸',
            uniqueSkill: 'Call Me King'
          }
        ];

        // Updated stat thresholds with accurate data from comprehensive guide
        const STAT_THRESHOLDS = {
          sprint: {
            'front-runner': { speed: 750, stamina: 300, power: 350, guts: 300, wisdom: 300 },
            'pace-chaser': { speed: 650, stamina: 350, power: 500, guts: 300, wisdom: 300 },
            'late-surger': { speed: 550, stamina: 400, power: 600, guts: 300, wisdom: 300 },
            'end-closer': { speed: 550, stamina: 450, power: 600, guts: 300, wisdom: 300 }
          },
          mile: {
            'front-runner': { speed: 750, stamina: 400, power: 350, guts: 300, wisdom: 300 },
            'pace-chaser': { speed: 650, stamina: 450, power: 500, guts: 300, wisdom: 300 },
            'late-surger': { speed: 550, stamina: 500, power: 600, guts: 300, wisdom: 300 },
            'end-closer': { speed: 550, stamina: 550, power: 600, guts: 300, wisdom: 300 }
          },
          medium: {
            'front-runner': { speed: 750, stamina: 450, power: 350, guts: 300, wisdom: 300 },
            'pace-chaser': { speed: 650, stamina: 500, power: 500, guts: 300, wisdom: 300 },
            'late-surger': { speed: 550, stamina: 550, power: 600, guts: 300, wisdom: 300 },
            'end-closer': { speed: 550, stamina: 600, power: 600, guts: 300, wisdom: 300 }
          },
          long: {
            'front-runner': { speed: 750, stamina: 500, power: 350, guts: 300, wisdom: 300 },
            'pace-chaser': { speed: 650, stamina: 550, power: 500, guts: 300, wisdom: 300 },
            'late-surger': { speed: 550, stamina: 600, power: 600, guts: 300, wisdom: 300 },
            'end-closer': { speed: 550, stamina: 650, power: 600, guts: 300, wisdom: 300 }
          }
        };

        // Stat efficiency thresholds and diminishing returns
        const STAT_EFFICIENCY = {
          optimal: { speed: 1200, guts: 400, wisdom: 400 },
          diminishingReturns: { speed: 1200, guts: 400, wisdom: 400 },
          warnings: {
            speedSoftCap: "Speed gains are halved after 1200. Consider focusing on other stats.",
            gutsOverInvest: "Guts above 400 gives minimal returns. Focus on core stats instead.",
            wisdomOverInvest: "Wisdom above 400 gives minimal returns. Skill activation is already consistent.",
            staminaOverflow: "This stamina level may be excessive for this distance. Check if it's needed."
          }
        };

        // Utility Functions
        function createElement(tag, className = '', innerHTML = '') {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (innerHTML) element.innerHTML = innerHTML;
            return element;
        }

        function getRarityStars(rarity) {
            return '★'.repeat(rarity);
        }

        function getStyleColor(style) {
            const colors = {
                'front-runner': 'bg-red-100 text-red-800',
                'pace-chaser': 'bg-blue-100 text-blue-800',
                'late-surger': 'bg-green-100 text-green-800',
                'end-closer': 'bg-purple-100 text-purple-800'
            };
            return colors[style] || 'bg-gray-100 text-gray-800';
        }

        function getStyleDisplayName(style) {
            const displayNames = {
                'front-runner': 'Front Runner',
                'pace-chaser': 'Pace Chaser',
                'late-surger': 'Late Surger',
                'end-closer': 'End Closer'
            };
            return displayNames[style] || style;
        }

        function getAptitudeColor(aptitude) {
            const colors = {
                'S': 'text-pink-600 font-bold',
                'A': 'text-green-600 font-bold',
                'B': 'text-blue-600 font-semibold',
                'C': 'text-yellow-600',
                'D': 'text-orange-600',
                'E': 'text-red-600',
                'F': 'text-red-700 font-bold',
                'G': 'text-gray-500'
            };
            return colors[aptitude] || 'text-gray-600';
        }

        function updateAppState(updates) {
            Object.assign(appState, updates);
            renderApp();
        }

        // Character filtering (search only)
        function getFilteredCharacters() {
            return CHARACTERS.filter(char => {
                return char.name.toLowerCase().includes(appState.searchTerm.toLowerCase());
            });
        }

        // Skill Recommendation System
        function getSkillRecommendations(character, targetTrack, style) {
            const recommendations = {
                essential: [],
                recommended: [],
                conditional: []
            };

            // Essential skills based on running style
            switch (style) {
                case 'front-runner':
                    recommendations.essential = [
                        { name: "Concentration", type: "Gold", reason: "Critical for sharp starts and maintaining lead" },
                        { name: "Corner Adept", type: "Silver", reason: "Reliable speed boost on every corner" }
                    ];
                    recommendations.recommended = [
                        { name: "Moxie (Restless)", type: "Gold", reason: "Mid-race stamina recovery for front runners" },
                        { name: "Taking the Lead", type: "Silver", reason: "Early race acceleration advantage" }
                    ];
                    break;
                case 'pace-chaser':
                    recommendations.essential = [
                        { name: "Professor of Curvature", type: "Gold", reason: "Superior corner speed for pace control" },
                        { name: "Speed Star (Prepare to Pass)", type: "Gold", reason: "Final corner acceleration for pace chasers" }
                    ];
                    recommendations.recommended = [
                        { name: "Hydrate (Gourmand)", type: "Gold", reason: "Mid-race stamina recovery for pace chasers" },
                        { name: "Corner Recovery", type: "Silver", reason: "Consistent stamina management" }
                    ];
                    break;
                case 'late-surger':
                    recommendations.essential = [
                        { name: "Fast & Furious", type: "Gold", reason: "Mid-race speed boost for late surgers" },
                        { name: "Lane Legerdemain", type: "Gold", reason: "Navigation for late-race positioning" }
                    ];
                    recommendations.recommended = [
                        { name: "Rising Dragon (Outer Swell)", type: "Gold", reason: "Outside passing on final corner" },
                        { name: "Soft Step (Miraculous Step)", type: "Gold", reason: "Corner stamina recovery" }
                    ];
                    break;
                case 'end-closer':
                    recommendations.essential = [
                        { name: "Encroaching Shadow", type: "Gold", reason: "Top-tier acceleration for final sprint" },
                        { name: "On Your Left! (Slick Surge)", type: "Gold", reason: "Late-race overtaking acceleration" }
                    ];
                    recommendations.recommended = [
                        { name: "Passing Prophecy (VIP Pass)", type: "Gold", reason: "Long race stamina recovery" },
                        { name: "Straightaway Spurt", type: "Silver", reason: "Final straight acceleration" }
                    ];
                    break;
            }

            // Distance-specific additions
            if (targetTrack === 'long') {
                recommendations.essential.push({
                    name: "Swinging Maestro",
                    type: "Gold",
                    reason: "Essential stamina recovery for 2400m+ races"
                });
            }

            // Character aptitude-based conditionals
            const characterAptitudes = character.aptitudes || {};
            
            // Right-handed track skills (most tracks are right-handed)
            recommendations.conditional.push({
                name: "Right-Handed ◎",
                type: "Passive",
                reason: "Most races are right-handed - consistent stat boost",
                priority: "High"
            });

            // Distance aptitude skills
            if (characterAptitudes[targetTrack] === 'A') {
                recommendations.conditional.push({
                    name: `${targetTrack.charAt(0).toUpperCase() + targetTrack.slice(1)} Distance ◎`,
                    type: "Passive",
                    reason: `Perfect aptitude match - maximizes ${targetTrack} performance`,
                    priority: "High"
                });
            }

            // Turf vs Dirt
            if (characterAptitudes.turf === 'A') {
                recommendations.conditional.push({
                    name: "Turf Specialist ◎",
                    type: "Passive", 
                    reason: "A-rank turf aptitude - essential for turf racing",
                    priority: "High"
                });
            }

            return recommendations;
        }

        const getCharacterTrainingAdvice = (character, targetTrack, style) => {
          const advice = {
            priority: [],
            secondary: [],
            avoid: [],
            tips: []
          };

          // Speed-focused characters (20% speed growth)
          if (character.statGrowth.speed === 20) {
            advice.priority.push("Speed training (take advantage of +20% growth bonus)");
            advice.tips.push("Your speed growth bonus makes speed training extremely efficient");
            if (style === 'front') {
              advice.tips.push("Perfect match: Front-runners need high speed and you have speed growth");
            }
          }

          // Stamina-focused characters (20% stamina growth)
          if (character.statGrowth.stamina === 20) {
            advice.priority.push("Stamina training (take advantage of +20% growth bonus)");
            advice.tips.push("Your stamina growth bonus is ideal for medium/long distance races");
            if (targetTrack === 'long') {
              advice.tips.push("Excellent choice: Long distances need stamina and you excel at it");
            }
          }

          // Power-focused characters
          if (character.statGrowth.power === 20 || character.statGrowth.power === 15) {
            advice.priority.push("Power training (take advantage of your power growth bonus)");
            advice.tips.push("Power growth bonus helps with acceleration and overtaking");
          }

          // High guts growth
          if (character.statGrowth.guts === 20) {
            advice.secondary.push("Guts training (you have good guts growth)");
            advice.tips.push("Your guts bonus helps with final spurt endurance");
          }

          // High wisdom growth
          if (character.statGrowth.wisdom === 20 || character.statGrowth.wisdom === 15) {
            advice.secondary.push("Wisdom training (you have good wisdom growth)");
            advice.tips.push("Your wisdom bonus improves skill activation consistency");
          }

          // Aptitude-based recommendations
          const apt = character.aptitudes[targetTrack];
          if (apt === 'A') {
            advice.tips.push(`Perfect distance match: You have A aptitude for ${targetTrack} races`);
          } else if (apt === 'B') {
            advice.tips.push(`Good distance match: You have B aptitude for ${targetTrack} races`);
          } else if (apt === 'C' || apt === 'D') {
            advice.tips.push(`Challenging distance: Your ${apt} aptitude for ${targetTrack} means you'll need higher stats`);
          } else {
            advice.avoid.push(`Warning: ${targetTrack} races (${apt} aptitude)`);
            advice.tips.push(`Consider switching distance: Your ${apt} aptitude makes ${targetTrack} very difficult`);
          }

          // Style aptitude warnings
          const runApt = character.runningStyles[style];
          if (['C','D'].includes(runApt)) {
            advice.tips.push(`Style challenge: Your ${runApt} aptitude for ${style} style may require higher stats`);
          } else if (['E','F','G'].includes(runApt)) {
            advice.avoid.push(`Warning: ${style} running style (${runApt} aptitude)`);
            advice.tips.push(`Consider switching style: Your ${runApt} aptitude makes ${style} very challenging`);
          }

          // Specific character tips
          if (character.id === 'special_week') {
            advice.tips.push("Versatile in medium/long distances, focus on stamina and wisdom for consistency");
          } else if (character.id === 'silence_suzuka') {
            advice.tips.push("Front-runner specialist, prioritize speed and avoid long distances");
          } else if (character.id === 'rice_shower') {
            advice.tips.push("Guts specialist perfect for come-from-behind victories in long races");
          } else if (character.id === 'haru_urara') {
            advice.tips.push("Dirt specialist - focus on dirt races and end-style running");
          }

          return advice;
        };

        // Skill recommendations by running style
        const SKILL_RECOMMENDATIONS = {
          'front-runner': {
            mustHave: ['Concentration', 'Sorry, Gotta Go!', 'Great Escape'],
            recommended: ['Corner Adept', 'Straight Adept', 'Right-Handed◎'],
            avoid: ['Overtaking skills', 'From-behind skills']
          },
          'pace-chaser': {
            mustHave: ['Speed Star', 'Positioning', 'Hydrate'],
            recommended: ['Corner Accel', 'Mid-race recovery', 'Might & Vision'],
            avoid: ['Early-phase speed boosts']
          },
          'late-surger': {
            mustHave: ['Furious Feat', 'Position Pilfer', 'Fast & Furious'],
            recommended: ['Corner bonuses', 'Straight bonuses', 'Overtake skills'],
            avoid: ['Front-runner only skills']
          },
          'end-closer': {
            mustHave: ['Encroaching Shadow', 'Corner Accel', 'Last-leg speed'],
            recommended: ['Multiple acceleration skills', 'Stamina recovery', 'Guts skills'],
            avoid: ['Early position skills']
          }
        };

        // Home Page Component
        function createHomePage() {
            const container = createElement('div', 'min-h-screen');
            
            const mainContainer = createElement('div', 'container mx-auto px-4 py-6');
            
            // Header
            const header = createElement('div', 'text-center mb-8');
            header.innerHTML = `
                <div class="flex justify-center items-center mb-4">
                    <!-- Logo container - smart fallback system -->
                    <div id="site-logo" class="transition-opacity duration-300">
                        <img id="logo-img" src="./logo.svg" alt="Uma Musume Career Planner" 
                             class="h-36 md:h-48 w-auto max-w-4xl mx-auto" style="display: block;">
                        <div id="logo-fallback" class="text-center" style="display: none;">
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-1">🏇 Uma Musume</h1>
                            <p class="text-base md:text-lg text-gray-600">Career Planner</p>
                        </div>
                    </div>
                </div>
            `;

            // Smart logo loading with fallback
            setTimeout(() => {
                const logoImg = document.getElementById('logo-img');
                const logoFallback = document.getElementById('logo-fallback');
                
                if (logoImg) {
                    logoImg.onerror = () => {
                        // Try PNG if SVG fails
                        logoImg.src = './logo.png';
                        logoImg.onerror = () => {
                            // If both fail, show text fallback
                            logoImg.style.display = 'none';
                            logoFallback.style.display = 'block';
                        };
                    };
                }
            }, 0);
            
            // Controls
            const controls = createElement('div', 'mb-6 space-y-4');
            
            // Search bar
            const searchContainer = createElement('div', 'relative');
            searchContainer.innerHTML = `
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">${Icons.Search}</span>
                <input type="text" id="search-input" placeholder="Search characters..." 
                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                       value="${appState.searchTerm}">
            `;
            
            const searchInput = searchContainer.querySelector('input');
            searchInput.addEventListener('input', (e) => {
                updateAppState({ searchTerm: e.target.value });
            });
            
            // Get characters based on search only
            const filteredCharacters = getFilteredCharacters();
            
            controls.appendChild(searchContainer);
            
            // Character sections by rarity
            const characterContainer = createElement('div', 'space-y-8');
            
            // Group characters by rarity
            const charactersByRarity = {
                3: filteredCharacters.filter(char => char.rarity === 3),
                2: filteredCharacters.filter(char => char.rarity === 2),
                1: filteredCharacters.filter(char => char.rarity === 1)
            };
            
            // Create sections for each rarity (show only if there are characters)
            [3, 2, 1].forEach(rarity => {
                const characters = charactersByRarity[rarity];
                if (characters.length === 0) return;
                
                const section = createElement('div', 'space-y-4');
                
                // Rarity header
                const header = createElement('div', 'flex items-center justify-between pb-2 border-b border-gray-200');
                const isFirstSection = rarity === 3; // Keep reference for unique IDs
                const showToggle = true; // Show toggle on all sections
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-bold text-gray-800">${getRarityStars(rarity)} Characters</h2>
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${characters.length} available</span>
                    </div>
                    ${showToggle ? `
                        <div class="flex items-center bg-gray-100 rounded-lg p-1">
                            <button id="costume-school${isFirstSection ? '' : '-' + rarity}" class="px-3 py-1 rounded-md text-sm font-medium transition-colors ${appState.costumeMode === 'school' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'}">
                                🏫 School
                            </button>
                            <button id="costume-secondary${isFirstSection ? '' : '-' + rarity}" class="px-3 py-1 rounded-md text-sm font-medium transition-colors ${appState.costumeMode === 'secondary' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'}">
                                ✨ Secondary
                            </button>
                        </div>
                    ` : ''}
                `;

                // Add costume toggle event handlers for each section
                if (showToggle) {
                    const schoolBtn = header.querySelector(`#costume-school${isFirstSection ? '' : '-' + rarity}`);
                    const secondaryBtn = header.querySelector(`#costume-secondary${isFirstSection ? '' : '-' + rarity}`);
                    
                    schoolBtn.addEventListener('click', () => {
                        updateAppState({ costumeMode: 'school' });
                    });
                    
                    secondaryBtn.addEventListener('click', () => {
                        updateAppState({ costumeMode: 'secondary' });
                    });
                }
                
                // Character grid for this rarity
                const grid = createElement('div', 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6');
                
                characters.forEach(character => {
                const card = createElement('div', 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer border border-gray-200 overflow-hidden');
                
                // Check if character has an image file and add background styling
                const hasCharacterImage = character.id; // We'll check if file exists
                const imagePath = appState.costumeMode === 'school' ? 
                    `./umaicons/school/${character.id}.webp` : 
                    `./umaicons/secondary/${character.id}.webp`;
                const backgroundStyle = hasCharacterImage ? 
                    `background-image: url('${imagePath}'); background-position: right center; background-repeat: no-repeat; background-size: contain; background-blend-mode: multiply;` : '';
                
                card.innerHTML = `
                    <div class="p-6 relative transition-all duration-300 ease-in-out" style="${backgroundStyle}">
                        <div class="absolute inset-0 bg-white bg-opacity-10 rounded-xl transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-4xl">${character.image}</div>
                                <div class="text-yellow-500 font-bold text-sm">${getRarityStars(character.rarity)}</div>
                            </div>
                            <div class="flex items-center gap-2 mb-3">
                                <h3 class="text-lg font-bold text-gray-800">${character.name}</h3>
                                <div class="flex flex-wrap gap-1">
                                    ${character.styles ? character.styles.map(style => `
                                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-opacity-90 ${getStyleColor(style)}">
                                            ${getStyleDisplayName(style)}
                                        </span>
                                    `).join('') : `
                                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-opacity-90 ${getStyleColor(character.defaultStyle)}">
                                            ${getStyleDisplayName(character.defaultStyle)}
                                        </span>
                                    `}
                                </div>
                            </div>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-600">Turf/Dirt:</span>
                                <div class="flex gap-1">
                                    <span class="${getAptitudeColor(character.aptitudes.turf)}">${character.aptitudes.turf}</span>
                                    <span class="text-gray-400">/</span>
                                    <span class="${getAptitudeColor(character.aptitudes.dirt)}">${character.aptitudes.dirt}</span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <div class="text-xs text-gray-500">Distance Aptitudes:</div>
                                <div class="flex flex-wrap gap-2 text-xs">
                                    <span>Sprint: <span class="${getAptitudeColor(character.aptitudes.sprint)}">${character.aptitudes.sprint}</span></span>
                                    <span>Mile: <span class="${getAptitudeColor(character.aptitudes.mile)}">${character.aptitudes.mile}</span></span>
                                    <span>Medium: <span class="${getAptitudeColor(character.aptitudes.medium)}">${character.aptitudes.medium}</span></span>
                                    <span>Long: <span class="${getAptitudeColor(character.aptitudes.long)}">${character.aptitudes.long}</span></span>
                                </div>
                            </div>
                            <div class="pt-2">
                                <div class="text-xs text-gray-500 mb-1">Fan Goals:</div>
                                <div class="flex flex-wrap gap-1">
                                    ${character.fanGoalThresholds.map(threshold => 
                                        `<span class="px-2 py-1 bg-gray-100 text-xs rounded">${threshold.toLocaleString()}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    updateAppState({ 
                        selectedCharacter: character, 
                        currentView: 'planner',
                        style: character.defaultStyle,
                        stats: character.baseStats // Initialize with character's base stats
                    });
                });
                
                grid.appendChild(card);
                });
                
                section.appendChild(header);
                section.appendChild(grid);
                characterContainer.appendChild(section);
            });
            
            // No results message
            if (filteredCharacters.length === 0) {
                const noResults = createElement('div', 'text-center py-12');
                noResults.innerHTML = `
                    <div class="text-gray-400 text-xl mb-2">🔍</div>
                    <p class="text-gray-500">No characters found matching your search.</p>
                `;
                characterContainer.appendChild(noResults);
            }
            
            mainContainer.appendChild(header);
            mainContainer.appendChild(controls);
            mainContainer.appendChild(characterContainer);
            container.appendChild(mainContainer);
            
            return container;
        }

        // Character Planner Component - Full Featured
        function createCharacterPlanner() {
            const container = createElement('div', 'min-h-screen');
            
            const mainContainer = createElement('div', 'container mx-auto px-4 py-6');
            
            // Back button
            const backButton = createElement('div', 'flex items-center mb-6');
            const backBtn = createElement('button', 'flex items-center gap-2 px-5 py-3 bg-white bg-opacity-90 text-gray-800 hover:text-gray-900 hover:bg-opacity-100 transition-all text-base font-medium rounded-lg shadow-sm border border-gray-200');
            backBtn.innerHTML = `${Icons.ArrowLeft} Back`;
            backBtn.addEventListener('click', () => {
                updateAppState({ currentView: 'home', selectedCharacter: null });
            });
            backButton.appendChild(backBtn);
            
            const character = appState.selectedCharacter;
            const thresholds = STAT_THRESHOLDS[appState.targetTrack][appState.style];
            
            // Helper functions
            const getStatColor = (value, threshold, stat) => {
                // Check for diminishing returns first
                if ((stat === 'speed' && value > 1200) || 
                    ((stat === 'guts' || stat === 'wisdom') && value > 400)) {
                  return value >= threshold ? 'text-orange-500' : 'text-red-600';
                }
                
                if (value >= threshold) return 'text-green-600';
                if (value >= threshold * 0.8) return 'text-yellow-600';
                return 'text-red-600';
            };

            const getStatEfficiencyWarning = (stat, value, threshold, targetTrack) => {
                if (stat === 'speed' && value > 1200) {
                  return STAT_EFFICIENCY.warnings.speedSoftCap;
                }
                if (stat === 'guts' && value > 400) {
                  return STAT_EFFICIENCY.warnings.gutsOverInvest;
                }
                if (stat === 'wisdom' && value > 400) {
                  return STAT_EFFICIENCY.warnings.wisdomOverInvest;
                }
                if (stat === 'stamina') {
                  const excessiveThresholds = {
                    sprint: 400, mile: 500, medium: 550, long: 650
                  };
                  if (value > excessiveThresholds[targetTrack] + 200) {
                    return STAT_EFFICIENCY.warnings.staminaOverflow;
                  }
                }
                return null;
            };

            const getTrainingRecommendations = () => {
                // Real Uma Musume training advisor system
                const trainingOptions = [
                    {
                        type: 'speed',
                        name: 'Speed Training',
                        primaryStat: 'speed',
                        primaryGain: 14, // Level 5 facility
                        secondaryStats: { power: 7 },
                        energyCost: 27,
                        skillPoints: 2
                    },
                    {
                        type: 'stamina', 
                        name: 'Stamina Training',
                        primaryStat: 'stamina',
                        primaryGain: 13,
                        secondaryStats: { guts: 6 },
                        energyCost: 25,
                        skillPoints: 2
                    },
                    {
                        type: 'power',
                        name: 'Power Training', 
                        primaryStat: 'power',
                        primaryGain: 12,
                        secondaryStats: { stamina: 7 },
                        energyCost: 26,
                        skillPoints: 2
                    },
                    {
                        type: 'guts',
                        name: 'Guts Training',
                        primaryStat: 'guts', 
                        primaryGain: 12,
                        secondaryStats: { speed: 5, power: 5 },
                        energyCost: 28,
                        skillPoints: 2
                    },
                    {
                        type: 'wisdom',
                        name: 'Wisdom Training',
                        primaryStat: 'wisdom',
                        primaryGain: 13,
                        secondaryStats: { speed: 4 },
                        energyCost: -5, // Restores energy
                        skillPoints: 4
                    }
                ];

                const recommendations = trainingOptions.map(training => {
                    const currentPrimary = appState.stats[training.primaryStat];
                    const thresholdPrimary = thresholds[training.primaryStat];
                    const primaryDeficit = Math.max(0, thresholdPrimary - currentPrimary);
                    
                    // Calculate total value of this training
                    let totalValue = 0;
                    let statGains = {};
                    
                    // Primary stat value
                    if (primaryDeficit > 0) {
                        const primaryProgress = Math.min(training.primaryGain, primaryDeficit);
                        totalValue += primaryProgress * 2; // Primary stats weighted higher
                        statGains[training.primaryStat] = training.primaryGain;
                    }
                    
                    // Secondary stat values
                    Object.entries(training.secondaryStats).forEach(([stat, gain]) => {
                        const currentStat = appState.stats[stat];
                        const thresholdStat = thresholds[stat];
                        const deficit = Math.max(0, thresholdStat - currentStat);
                        
                        if (deficit > 0) {
                            const progress = Math.min(gain, deficit);
                            totalValue += progress * 1; // Secondary stats normal weight
                            statGains[stat] = gain;
                        }
                    });
                    
                    // Energy efficiency factor
                    const energyEfficiency = training.energyCost <= 0 ? 1.5 : 
                                           training.energyCost <= 25 ? 1.2 :
                                           training.energyCost <= 27 ? 1.0 : 0.8;
                    
                    totalValue *= energyEfficiency;
                    
                    // Special bonuses
                    let specialNotes = [];
                    
                    // Wisdom training bonus (energy recovery + skill points)
                    if (training.type === 'wisdom') {
                        specialNotes.push("Restores 5 energy");
                        specialNotes.push("Double skill points (+4 SP)");
                        totalValue += 10; // Bonus for utility
                    }
                    
                    // Multi-stat training bonus
                    if (Object.keys(training.secondaryStats).length > 1) {
                        specialNotes.push("Trains multiple stats");
                        totalValue += 5;
                    }
                    
                    // Critical need bonus
                    if (primaryDeficit > 200) {
                        specialNotes.push(`Critical ${training.primaryStat} need!`);
                        totalValue *= 1.5;
                    }
                    
                    return {
                        ...training,
                        totalValue: Math.round(totalValue),
                        statGains,
                        deficit: primaryDeficit,
                        specialNotes,
                        recommendation: generateTrainingAdvice(training, primaryDeficit, statGains, specialNotes)
                    };
                });

                return recommendations.sort((a, b) => b.totalValue - a.totalValue);
            };

            const generateTrainingAdvice = (training, deficit, statGains, specialNotes) => {
                const statGainText = Object.entries(statGains)
                    .map(([stat, gain]) => `+${gain} ${stat.charAt(0).toUpperCase() + stat.slice(1)}`)
                    .join(', ');
                
                let advice = `Gains: ${statGainText}`;
                
                if (deficit > 150) {
                    advice += ` | High priority - large ${training.primaryStat} gap`;
                } else if (deficit > 50) {
                    advice += ` | Good progress toward ${training.primaryStat} goal`;
                } else if (deficit > 0) {
                    advice += ` | Finishing touches on ${training.primaryStat}`;
                }
                
                if (specialNotes.length > 0) {
                    advice += ` | ${specialNotes.join(', ')}`;
                }
                
                return advice;
            };

            const getStatRecommendation = (stat, current, threshold, deficit) => {
                if (deficit <= 25) {
                  return `Almost there! +${deficit} ${stat} to reach threshold`;
                } else if (deficit <= 100) {
                  return `Focus on ${stat} training - need +${deficit} more`;
                } else {
                  return `Priority: ${stat} training - significant gap of ${deficit}`;
                }
            };

            const getOverallStatus = () => {
                const trainingOptions = getTrainingRecommendations();
                
                // Check for efficiency warnings
                const efficiencyWarnings = Object.entries(appState.stats)
                  .map(([stat, value]) => getStatEfficiencyWarning(stat, value, thresholds[stat], appState.targetTrack))
                  .filter(warning => warning !== null);
                
                // Check if all stats meet thresholds
                const allStatsMet = Object.entries(thresholds).every(([stat, threshold]) => 
                    appState.stats[stat] >= threshold
                );
                
                if (allStatsMet) {
                  return { 
                    status: 'success', 
                    message: '✅ Perfect! All stats meet URA Finals requirements.' 
                  };
                }
                
                const topTraining = trainingOptions[0];
                const secondTraining = trainingOptions[1];
                
                if (efficiencyWarnings.length > 0) {
                  return { 
                    status: 'warning', 
                    message: `⚠️ Efficiency Warning: ${efficiencyWarnings[0]}` 
                  };
                }
                
                // Generate intelligent training recommendations based on Uma Musume mechanics
                const hasLargeDeficits = trainingOptions.some(t => t.deficit > 200);
                const topValue = topTraining.totalValue;
                const secondValue = secondTraining.totalValue;
                
                // Critical training recommendation (large stat gaps)
                if (hasLargeDeficits && topTraining.deficit > 200) {
                  return { 
                    status: 'critical', 
                    message: `🚨 Recommended Training: ${topTraining.name} | ${topTraining.recommendation}` 
                  };
                }
                
                // High value training with close alternative
                if (Math.abs(topValue - secondValue) <= 5) {
                  return { 
                    status: 'info', 
                    message: `📊 Training Options: ${topTraining.name} or ${secondTraining.name} | Both provide good value` 
                  };
                }
                
                // Clear best training choice
                if (topValue > secondValue + 10) {
                  return { 
                    status: 'warning', 
                    message: `⚠️ Recommended Training: ${topTraining.name} | ${topTraining.recommendation.split('|')[0].trim()}` 
                  };
                }
                
                // General recommendation
                return { 
                  status: 'info', 
                  message: `📈 Next Training: ${topTraining.name} | ${topTraining.recommendation.split('|')[0].trim()}` 
                };
            };

            const overallStatus = getOverallStatus();
            const trainingRecommendations = getTrainingRecommendations();
            const characterAdvice = getCharacterTrainingAdvice(character, appState.targetTrack, appState.style);

            // Main header panel (without status badge)
            const mainPanel = createElement('div', 'bg-white rounded-xl shadow-lg p-6 mb-6');
            mainPanel.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-5xl">${character.image}</div>
                    <div class="flex-1">
                        <h1 class="text-2xl font-bold text-gray-800">${character.name}</h1>
                        <div class="flex items-center gap-2 mt-1 mb-3">
                            <span class="text-yellow-500 font-bold">${getRarityStars(character.rarity)}</span>
                            <div class="flex flex-wrap gap-1">
                                ${character.styles ? character.styles.map(style => `
                                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-opacity-90 ${getStyleColor(style)}">
                                        ${getStyleDisplayName(style)}
                                    </span>
                                `).join('') : `
                                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-opacity-90 ${getStyleColor(character.defaultStyle)}">
                                        ${getStyleDisplayName(character.defaultStyle)}
                                    </span>
                                `}
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-4">
                                <span class="text-gray-600 font-medium">Surface:</span>
                                <div class="flex gap-1">
                                    <span>Turf: <span class="${getAptitudeColor(character.aptitudes.turf)}">${character.aptitudes.turf}</span></span>
                                    <span class="text-gray-400">•</span>
                                    <span>Dirt: <span class="${getAptitudeColor(character.aptitudes.dirt)}">${character.aptitudes.dirt}</span></span>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-gray-600 font-medium">Distance:</span>
                                <div class="flex flex-wrap gap-2">
                                    <span>Sprint: <span class="${getAptitudeColor(character.aptitudes.sprint)}">${character.aptitudes.sprint}</span></span>
                                    <span>Mile: <span class="${getAptitudeColor(character.aptitudes.mile)}">${character.aptitudes.mile}</span></span>
                                    <span>Medium: <span class="${getAptitudeColor(character.aptitudes.medium)}">${character.aptitudes.medium}</span></span>
                                    <span>Long: <span class="${getAptitudeColor(character.aptitudes.long)}">${character.aptitudes.long}</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Performance Status Panel - Prominent display for critical feedback
            const statusPanel = createElement('div', 'mb-6');
            const statusClass = overallStatus.status === 'success' ? 'border-green-500 bg-green-50' : 
                               overallStatus.status === 'critical' ? 'border-red-500 bg-red-50' :
                               overallStatus.status === 'warning' ? 'border-yellow-500 bg-yellow-50' : 
                               'border-blue-500 bg-blue-50';
            
            const statusIcon = overallStatus.status === 'success' ? '✅' : 
                              overallStatus.status === 'critical' ? '🚨' :
                              overallStatus.status === 'warning' ? '⚠️' : 
                              '📊';

            statusPanel.innerHTML = `
                <div class="rounded-xl border-l-4 ${statusClass} ${statusClass.replace('border-', 'border-l-')} p-4 shadow-md">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">${statusIcon}</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg ${
                                overallStatus.status === 'success' ? 'text-green-800' : 
                                overallStatus.status === 'critical' ? 'text-red-800' :
                                overallStatus.status === 'warning' ? 'text-yellow-800' : 
                                'text-blue-800'
                            } mb-1">Performance Analysis</h3>
                            <p class="text-base ${
                                overallStatus.status === 'success' ? 'text-green-700' : 
                                overallStatus.status === 'critical' ? 'text-red-700' :
                                overallStatus.status === 'warning' ? 'text-yellow-700' : 
                                'text-blue-700'
                            }">${overallStatus.message}</p>
                            ${overallStatus.status === 'critical' ? `
                                <div class="mt-2 text-sm text-red-600 bg-red-100 rounded-md p-2">
                                    <strong>💡 Quick Fix:</strong> Focus training on the highlighted stat deficit to meet URA Finals requirements for your selected distance and running style.
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Stats planning section
            const statsSection = createElement('div', 'grid grid-cols-1 lg:grid-cols-2 gap-8');
            
            // Left side - Stat sliders
            const leftPanel = createElement('div', 'space-y-6');
            leftPanel.innerHTML = `
                <!-- Quick Import Section -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                    <h3 class="font-semibold text-blue-800 flex items-center gap-2">
                        <span>📋</span>
                        Quick Import Stats
                    </h3>
                    <div class="text-xs text-blue-700 mb-2">
                        Enter 5 numbers in order:<br>
                        Speed, Stamina, Power, Guts, Wisdom<br>
                        Any format works: "450 550 400 350 300" or "450, 550, 400, 350, 300"
                        <br><span class="font-medium">⌨️ Press Enter to import quickly!</span>
                    </div>
                    <textarea id="stats-import" placeholder="Enter 5 numbers separated by spaces/commas (Speed, Stamina, Power, Guts, Wisdom)" 
                              class="w-full px-3 py-2 text-sm border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                              rows="2"></textarea>
                    <div class="flex gap-2">
                        <button id="import-stats-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                            Import Stats
                        </button>
                        <button id="reset-stats-btn" class="px-4 py-2 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600 transition-colors">
                            Reset to Base
                        </button>
                    </div>
                </div>
            `;

            // Create Stat Planning container
            const statPlanningContainer = createElement('div', 'bg-white bg-opacity-90 rounded-lg p-4 shadow-sm border border-gray-200 space-y-4');
            const statPlanningHeader = createElement('h2', 'text-xl font-bold text-gray-800 flex items-center gap-2');
            statPlanningHeader.innerHTML = `<span>${Icons.Target}</span> Stat Planning`;
            statPlanningContainer.appendChild(statPlanningHeader);
            
            // Create enhanced stat controls with +/- buttons
            Object.entries(appState.stats).forEach(([stat, value]) => {
                const warning = getStatEfficiencyWarning(stat, value, thresholds[stat], appState.targetTrack);
                const progressPercent = Math.min((value / thresholds[stat]) * 100, 100);
                const isOptimal = value >= thresholds[stat];
                
                const statControl = createElement('div', 'space-y-3 p-4 bg-white rounded-lg border border-gray-200');
                statControl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-semibold text-gray-800 capitalize">${stat}</label>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">Required:</span>
                            <span class="text-sm font-medium ${getStatColor(value, thresholds[stat], stat)}">
                                ${value} / ${thresholds[stat]}
                            </span>
                            ${isOptimal ? '<span class="text-xs text-green-600">✓</span>' : ''}
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                        <div class="h-2 rounded-full transition-all duration-300 ${
                            isOptimal ? 'bg-green-500' : value >= thresholds[stat] * 0.8 ? 'bg-yellow-500' : 'bg-red-500'
                        }" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <!-- Input Controls -->
                    <div class="flex items-center gap-2">
                        <button class="stat-btn-minus flex-shrink-0 w-10 h-10 rounded-lg border-2 border-gray-300 hover:border-pink-400 hover:bg-pink-50 flex items-center justify-center font-bold text-gray-600 hover:text-pink-600 transition-colors" 
                                data-stat="${stat}" data-action="minus">
                            −
                        </button>
                        
                        <div class="flex-1 relative">
                            <input type="number" min="0" max="1200" value="${value}" 
                                   class="stat-input w-full px-4 py-3 text-center text-lg font-semibold border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                   data-stat="${stat}" placeholder="Enter value">
                        </div>
                        
                        <button class="stat-btn-plus flex-shrink-0 w-10 h-10 rounded-lg border-2 border-gray-300 hover:border-pink-400 hover:bg-pink-50 flex items-center justify-center font-bold text-gray-600 hover:text-pink-600 transition-colors" 
                                data-stat="${stat}" data-action="plus">
                            +
                        </button>
                    </div>
                    
                    <!-- Quick increment buttons -->
                    <div class="flex gap-2 justify-center">
                        <button class="quick-add-btn px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" 
                                data-stat="${stat}" data-amount="10">+10</button>
                        <button class="quick-add-btn px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" 
                                data-stat="${stat}" data-amount="25">+25</button>
                        <button class="quick-add-btn px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" 
                                data-stat="${stat}" data-amount="50">+50</button>
                        <button class="quick-add-btn px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" 
                                data-stat="${stat}" data-amount="100">+100</button>
                    </div>
                    
                    ${warning ? `<div class="text-xs text-orange-700 bg-orange-50 border border-orange-200 p-3 rounded-md">
                        <span class="font-semibold">⚡ Efficiency Notice:</span> ${warning}
                    </div>` : ''}
                `;
                statPlanningContainer.appendChild(statControl);
            });
            
            // Add the stat planning container to the left panel
            leftPanel.appendChild(statPlanningContainer);

            // Right side - Controls and recommendations
            const rightPanel = createElement('div', 'space-y-4');
            
            // Base stats reference
            const baseStatsPanel = createElement('div', 'bg-gray-50 rounded-lg p-4');
            baseStatsPanel.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <span>${Icons.Star}</span>
                    Base Stats Reference
                </h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    ${Object.entries(character.baseStats).map(([stat, value]) => `
                        <div class="flex justify-between">
                            <span class="text-gray-600 capitalize">${stat}:</span>
                            <span class="font-medium text-gray-800">${value}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    Starting values for ${character.name} at initial ★${character.rarity}
                </div>
            `;
            
            // Distance and style selectors
            const selectors = createElement('div', 'bg-white bg-opacity-90 rounded-lg p-4 shadow-sm border border-gray-200 space-y-4');
            selectors.innerHTML = `
                <div>
                    <label class="block text-base font-semibold text-gray-800 mb-2">Target Style</label>
                    <select id="style-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                        ${STYLES.map(style => `
                            <option value="${style}" ${appState.style === style ? 'selected' : ''}>
                                ${getStyleDisplayName(style)}
                            </option>
                        `).join('')}
                    </select>
                </div>
                
                <div>
                    <label class="block text-base font-semibold text-gray-800 mb-2">Target Distance</label>
                    <select id="distance-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                        ${TRACK_TYPES.map(track => `
                            <option value="${track}" ${appState.targetTrack === track ? 'selected' : ''}>
                                ${track.charAt(0).toUpperCase() + track.slice(1)}
                            </option>
                        `).join('')}
                    </select>
                </div>
            `;

            // Training recommendations
            if (trainingRecommendations.length > 0) {
                const trainingPanel = createElement('div', 'bg-gray-50 rounded-lg p-4');
                trainingPanel.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <span>${Icons.TrendingUp}</span>
                        Training Recommendations
                    </h3>
                    <div class="space-y-3">
                        ${trainingRecommendations.slice(0, 5).map((training, idx) => `
                            <div class="p-3 bg-white rounded-md border-l-4 ${
                                idx === 0 ? 'border-green-500' : 
                                idx === 1 ? 'border-blue-500' : 
                                idx === 2 ? 'border-yellow-500' : 'border-gray-300'
                            }">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white ${
                                            idx === 0 ? 'bg-green-500' : 
                                            idx === 1 ? 'bg-blue-500' : 
                                            idx === 2 ? 'bg-yellow-500' : 'bg-gray-400'
                                        }">${idx + 1}</span>
                                        <span class="font-medium">${training.name}</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-semibold text-gray-700">Value: ${training.totalValue}</div>
                                        <div class="text-xs text-gray-500">Energy: ${training.energyCost > 0 ? `-${training.energyCost}` : `+${Math.abs(training.energyCost)}`}</div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-600">${training.recommendation}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-600">
                        💡 Recommendations based on actual Uma Musume training mechanics: stat gains, energy costs, and secondary benefits.
                    </div>
                `;
                rightPanel.appendChild(selectors);
                rightPanel.appendChild(trainingPanel);
            }

            // Character advice panel
            const advicePanel = createElement('div', 'bg-blue-50 rounded-lg p-4');
            advicePanel.innerHTML = `
                <h3 class="text-lg font-semibold text-blue-800 mb-3 flex items-center gap-2">
                    <span>${Icons.Users}</span>
                    Character Training Guide
                </h3>
                <div class="space-y-3">
                    ${characterAdvice.priority.length > 0 ? `
                        <div>
                            <h4 class="font-semibold text-blue-700 mb-2">🎯 Priority Training</h4>
                            <div class="space-y-1">
                                ${characterAdvice.priority.map(advice => `
                                    <div class="text-sm text-blue-800 bg-blue-100 p-2 rounded">${advice}</div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${characterAdvice.secondary.length > 0 ? `
                        <div>
                            <h4 class="font-semibold text-blue-700 mb-2">📈 Secondary Focus</h4>
                            <div class="space-y-1">
                                ${characterAdvice.secondary.map(advice => `
                                    <div class="text-sm text-blue-800 bg-blue-100 p-2 rounded">${advice}</div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${characterAdvice.avoid.length > 0 ? `
                        <div>
                            <h4 class="font-semibold text-red-700 mb-2">⚠️ Avoid</h4>
                            <div class="space-y-1">
                                ${characterAdvice.avoid.map(advice => `
                                    <div class="text-sm text-red-800 bg-red-100 p-2 rounded">${advice}</div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${characterAdvice.tips.length > 0 ? `
                        <div>
                            <h4 class="font-semibold text-green-700 mb-2">💡 Tips</h4>
                            <div class="space-y-1">
                                ${characterAdvice.tips.map(tip => `
                                    <div class="text-sm text-green-800 bg-green-100 p-2 rounded">${tip}</div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Skill recommendations panel
            const skillRecommendations = getSkillRecommendations(character, appState.targetTrack, appState.style);
            const skillPanel = createElement('div', 'bg-purple-50 rounded-lg p-4');
            skillPanel.innerHTML = `
                <h3 class="text-lg font-semibold text-purple-800 mb-3 flex items-center gap-2">
                    <span>${Icons.Sparkles}</span>
                    Recommended Skills
                </h3>
                
                ${skillRecommendations.essential.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-semibold text-purple-700 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                            Essential Skills
                        </h4>
                        <div class="space-y-2">
                            ${skillRecommendations.essential.map(skill => `
                                <div class="bg-white p-3 rounded-md border-l-4 border-red-500">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-medium text-purple-900">${skill.name}</span>
                                        <span class="text-xs px-2 py-1 rounded-full ${
                                            skill.type === 'Gold' ? 'bg-yellow-100 text-yellow-800' : 
                                            skill.type === 'Silver' ? 'bg-gray-100 text-gray-800' : 
                                            'bg-green-100 text-green-800'
                                        }">${skill.type}</span>
                                    </div>
                                    <p class="text-sm text-purple-700">${skill.reason}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${skillRecommendations.recommended.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-semibold text-purple-700 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            Recommended Skills
                        </h4>
                        <div class="space-y-2">
                            ${skillRecommendations.recommended.map(skill => `
                                <div class="bg-white p-3 rounded-md border-l-4 border-blue-500">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-medium text-purple-900">${skill.name}</span>
                                        <span class="text-xs px-2 py-1 rounded-full ${
                                            skill.type === 'Gold' ? 'bg-yellow-100 text-yellow-800' : 
                                            skill.type === 'Silver' ? 'bg-gray-100 text-gray-800' : 
                                            'bg-green-100 text-green-800'
                                        }">${skill.type}</span>
                                    </div>
                                    <p class="text-sm text-purple-700">${skill.reason}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${skillRecommendations.conditional.length > 0 ? `
                    <div>
                        <h4 class="font-semibold text-purple-700 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            Conditional Skills
                        </h4>
                        <div class="space-y-2">
                            ${skillRecommendations.conditional.map(skill => `
                                <div class="bg-white p-3 rounded-md border-l-4 border-green-500">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-medium text-purple-900">${skill.name}</span>
                                        <span class="text-xs px-2 py-1 rounded-full ${
                                            skill.type === 'Gold' ? 'bg-yellow-100 text-yellow-800' : 
                                            skill.type === 'Silver' ? 'bg-gray-100 text-gray-800' : 
                                            'bg-green-100 text-green-800'
                                        }">${skill.type}</span>
                                    </div>
                                    <p class="text-sm text-purple-700">${skill.reason}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="mt-4 p-3 bg-purple-100 rounded-md">
                    <p class="text-xs text-purple-800">
                        <strong>💡 Career Planning Tip:</strong> Focus on Essential skills first, then add Recommended skills. 
                        Conditional skills provide consistent stat boosts when conditions match your target races.
                    </p>
                </div>
            `;

            rightPanel.appendChild(advicePanel);
            rightPanel.appendChild(skillPanel);
            
            statsSection.appendChild(leftPanel);
            statsSection.appendChild(rightPanel);

            // Event listeners for stat controls
            const handleStatChange = (stat, value) => {
                const numValue = parseInt(value) || 0;
                const clampedValue = Math.max(0, Math.min(1200, numValue));
                updateAppState({
                    stats: {
                        ...appState.stats,
                        [stat]: clampedValue
                    }
                });
            };

            // Event listeners are now handled globally via event delegation to prevent duplicates
            // No need to add them here as they are set up once in the initialization

            // Import stats functionality
            setTimeout(() => {
                const importBtn = document.getElementById('import-stats-btn');
                const importText = document.getElementById('stats-import');
                
                if (importBtn && importText) {
                    // Shared import logic to avoid duplication
                    const performImport = () => {
                        const text = importText.value.trim();
                        if (!text) return;
                        
                        let imported = 0;
                        const stats = ['speed', 'stamina', 'power', 'guts', 'wisdom'];
                        let newStats = { ...appState.stats };
                        
                        // Method 1: Try parsing as simple numbers in order (most common)
                        const numbers = text.match(/\d+/g);
                        if (numbers && numbers.length >= 5) {
                            stats.forEach((stat, index) => {
                                if (numbers[index]) {
                                    const value = Math.max(0, Math.min(1200, parseInt(numbers[index])));
                                    const input = document.querySelector(`.stat-input[data-stat="${stat}"]`);
                                    if (input) {
                                        input.value = value;
                                        newStats[stat] = value;
                                        imported++;
                                    }
                                }
                            });
                        } else {
                            // Method 2: Try parsing with labels (fallback)
                            const statPatterns = {
                                speed: /(?:speed|sp|スピード)[\s:]*(\d+)/i,
                                stamina: /(?:stamina|st|スタミナ)[\s:]*(\d+)/i,
                                power: /(?:power|pw|パワー)[\s:]*(\d+)/i,
                                guts: /(?:guts|gt|根性)[\s:]*(\d+)/i,
                                wisdom: /(?:wisdom|wi|wit|賢さ)[\s:]*(\d+)/i
                            };
                            
                            stats.forEach(stat => {
                                const match = text.match(statPatterns[stat]);
                                if (match) {
                                    const value = Math.max(0, Math.min(1200, parseInt(match[1])));
                                    const input = document.querySelector(`.stat-input[data-stat="${stat}"]`);
                                    if (input) {
                                        input.value = value;
                                        newStats[stat] = value;
                                        imported++;
                                    }
                                }
                            });
                        }
                        
                        // Update all stats at once to avoid multiple re-renders
                        if (imported > 0) {
                            appState.stats = newStats;
                            renderApp();
                            
                            importText.value = '';
                            importText.placeholder = `✅ Imported ${imported} stats!`;
                            setTimeout(() => {
                                importText.placeholder = 'Enter 5 numbers separated by spaces/commas (Speed, Stamina, Power, Guts, Wisdom)';
                            }, 2000);
                        } else {
                            importText.placeholder = '❌ Please enter 5 numbers (e.g., "450 550 400 350 300")';
                            setTimeout(() => {
                                importText.placeholder = 'Enter 5 numbers separated by spaces/commas (Speed, Stamina, Power, Guts, Wisdom)';
                            }, 3000);
                        }
                    };

                    // Click handler for button
                    importBtn.addEventListener('click', performImport);
                    
                    // Enter key support for textarea
                    importText.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault(); // Prevent newline in textarea
                            performImport();
                        }
                    });
                }

                // Reset to Base functionality
                const resetBtn = document.getElementById('reset-stats-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        const character = appState.selectedCharacter;
                        if (!character) return;
                        
                        // Reset all stats to character's actual base stats
                        const stats = ['speed', 'stamina', 'power', 'guts', 'wisdom'];
                        let newStats = {};
                        stats.forEach(stat => {
                            const input = document.querySelector(`.stat-input[data-stat="${stat}"]`);
                            if (input && character.baseStats && character.baseStats[stat] !== undefined) {
                                const baseValue = character.baseStats[stat];
                                input.value = baseValue;
                                newStats[stat] = baseValue;
                            }
                        });
                        
                        // Update all stats at once to avoid multiple re-renders
                        appState.stats = newStats;
                        renderApp();
                    });
                }
                // Style selector
                const styleSelect = document.getElementById('style-select');
                if (styleSelect) {
                    styleSelect.addEventListener('change', (e) => {
                        updateAppState({ style: e.target.value });
                    });
                }

                // Distance selector
                const distanceSelect = document.getElementById('distance-select');
                if (distanceSelect) {
                    distanceSelect.addEventListener('change', (e) => {
                        updateAppState({ targetTrack: e.target.value });
                    });
                }
            }, 0);

            mainContainer.appendChild(backButton);
            mainContainer.appendChild(mainPanel);
            mainContainer.appendChild(statusPanel);
            mainContainer.appendChild(statsSection);
            container.appendChild(mainContainer);
            
            return container;
        }

        // Main App Render Function
        function renderApp() {
            const root = document.getElementById('root');
            
            // Preserve search input focus and cursor position if it exists
            const currentSearchInput = document.querySelector('#search-input');
            const wasSearchFocused = currentSearchInput && document.activeElement === currentSearchInput;
            const cursorPosition = wasSearchFocused ? currentSearchInput.selectionStart : null;
            
            root.innerHTML = '';
            
            if (appState.currentView === 'home') {
                root.appendChild(createHomePage());
                
                // Restore search input focus and cursor position after render
                if (wasSearchFocused) {
                    setTimeout(() => {
                        const newSearchInput = document.querySelector('#search-input');
                        if (newSearchInput) {
                            newSearchInput.focus();
                            if (cursorPosition !== null) {
                                newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                            }
                        }
                    }, 0);
                }
            } else if (appState.currentView === 'planner') {
                root.appendChild(createCharacterPlanner());
            }
        }

        // Global event delegation for stat controls to prevent duplicate listeners
        function setupGlobalEventDelegation() {
            // Handle stat button clicks (plus/minus and quick increment)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('stat-btn-plus') || e.target.classList.contains('stat-btn-minus')) {
                    const stat = e.target.dataset.stat;
                    const action = e.target.dataset.action;
                    const input = document.querySelector(`.stat-input[data-stat="${stat}"]`);
                    if (!input) return;
                    
                    const currentValue = parseInt(input.value) || 0;
                    let newValue;
                    if (action === 'plus') {
                        newValue = Math.min(1200, currentValue + 1);
                    } else {
                        newValue = Math.max(0, currentValue - 1);
                    }
                    
                    input.value = newValue;
                    // Update state without re-rendering to avoid duplicating listeners
                    const numValue = parseInt(newValue) || 0;
                    const clampedValue = Math.max(0, Math.min(1200, numValue));
                    appState.stats = { ...appState.stats, [stat]: clampedValue };
                    // Trigger a re-render
                    renderApp();
                    
                } else if (e.target.classList.contains('quick-add-btn')) {
                    const stat = e.target.dataset.stat;
                    const increment = parseInt(e.target.dataset.amount);
                    const input = document.querySelector(`.stat-input[data-stat="${stat}"]`);
                    if (!input) return;
                    
                    const currentValue = parseInt(input.value) || 0;
                    const newValue = Math.max(0, Math.min(1200, currentValue + increment));
                    
                    input.value = newValue;
                    // Update state without re-rendering to avoid duplicating listeners
                    const numValue = parseInt(newValue) || 0;
                    const clampedValue = Math.max(0, Math.min(1200, numValue));
                    appState.stats = { ...appState.stats, [stat]: clampedValue };
                    // Trigger a re-render
                    renderApp();
                }
            });
            
            // Handle stat input changes
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('stat-input')) {
                    const value = Math.max(0, Math.min(1200, parseInt(e.target.value) || 0));
                    e.target.value = value; // Update display
                    const stat = e.target.dataset.stat;
                    
                    // Update state without re-rendering to avoid duplicating listeners
                    const numValue = parseInt(value) || 0;
                    const clampedValue = Math.max(0, Math.min(1200, numValue));
                    appState.stats = { ...appState.stats, [stat]: clampedValue };
                    // Trigger a re-render
                    renderApp();
                }
            });
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            setupGlobalEventDelegation();
            renderApp();
        });
    </script>

    <!-- Register service worker for PWA functionality -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>